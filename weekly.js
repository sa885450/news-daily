require('dotenv').config();
const cron = require('node-cron');
const db = require('./lib/db'); // ğŸŸ¢ ä½¿ç”¨å…±ç”¨ DB æ¨¡çµ„ (è§£æ±ºè·¯å¾‘èˆ‡ Table å•é¡Œ)
const { getSummary } = require('./lib/ai');
const { sendDiscord, log } = require('./lib/utils');

async function runWeeklyTask() {
    log('ğŸ“…', 'é–‹å§‹åŸ·è¡Œé€±å ±ä»»å‹™...');

    try {
        // 1. å¾è³‡æ–™åº«æ’ˆå–æœ¬é€±æ–°è
        const articles = db.getWeeklyArticles();
        
        if (articles.length === 0) {
            log('ğŸ’¤', 'éå» 7 å¤©ç„¡æ–°èè³‡æ–™ï¼Œè·³éé€±å ±ã€‚');
            return;
        }

        log('ğŸ“Š', `æœ¬é€±ç´¯ç©æ–°è: ${articles.length} å‰‡ï¼Œæº–å‚™é€²è¡Œ AI æ¿ƒç¸®...`);

        // 2. ç‚ºäº†é¿å… AI Token çˆ†ç‚¸ï¼Œæˆ‘å€‘åªå–æœ€è¿‘çš„ 50-60 å‰‡ä»£è¡¨æ€§æ–°è
        // (æˆ–æ˜¯ä½ å¯ä»¥é¸æ“‡éš¨æ©ŸæŠ½æ¨£ï¼Œé€™è£¡å…ˆå–æœ€æ–°çš„)
        const selectedArticles = articles.slice(0, 60);

        // 3. å‘¼å« AI é€²è¡Œåˆ†æ (å‚³å…¥ null ä»£è¡¨ä¸ä½¿ç”¨å¢é‡æ¨¡å¼ï¼Œè€Œæ˜¯å…¨æ–°åˆ†æ)
        const aiResult = await getSummary(selectedArticles, null);

        // 4. æ ¼å¼åŒ–é€±å ±å…§å®¹
        const weeklyReport = `
# ğŸ“… **AI æŠ•è³‡é€±å ± (Weekly Insight)**
---
**æœ¬é€±æƒ…ç·’æŒ‡æ•¸**: ${aiResult.sentiment_score > 0 ? 'ğŸ”¥' : 'â„ï¸'} ${aiResult.sentiment_score}

## ğŸ“ **ä¸€é€±é‡é»å›é¡§**
${aiResult.summary.replace(/<[^>]*>/g, '')} 
*(å·²å»é™¤ HTML æ¨™ç±¤ä»¥é©æ‡‰ Discord)*

## ğŸ¤– **æœ¬é€±é—œéµå¯¦é«”**
${aiResult.entities ? aiResult.entities.map(e => `#${e}`).join(' ') : 'ç„¡'}

---
*Generated by NewsBot v2.4*
        `.trim();

        // 5. ç™¼é€
        await sendDiscord(weeklyReport);
        log('âœ…', 'é€±å ±ç™¼é€å®Œæˆï¼');

    } catch (e) {
        log('âŒ', `é€±å ±åŸ·è¡Œå¤±æ•—: ${e.message}`);
        console.error(e);
    }
}

// è¨­å®šæ’ç¨‹ï¼šæ¯é€±äº” ä¸‹åˆ 5:00 åŸ·è¡Œ (æˆ–æ˜¯ä½ å–œæ­¡çš„æ™‚é–“)
log('ğŸ•°ï¸', 'é€±å ±æ©Ÿå™¨äººå·²å°±ç·’ (æ¯é€±äº” 17:00)');
cron.schedule('0 17 * * 5', () => runWeeklyTask());

// å¦‚æœä½ æƒ³æ¸¬è©¦ï¼Œå¯ä»¥å–æ¶ˆä¸‹é¢é€™è¡Œçš„è¨»è§£ï¼Œé‡å•Ÿå¾Œæœƒé¦¬ä¸Šè·‘ä¸€æ¬¡
// runWeeklyTask();