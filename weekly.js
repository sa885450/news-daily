require('dotenv').config();
const cron = require('node-cron');
const db = require('./lib/db');
const { getSummary, getOpenAISummary } = require('./lib/ai');
const { openaiKey } = require('./lib/config');
const { sendDiscord, log } = require('./lib/utils');

async function runWeeklyTask() {
    log('ğŸ“…', 'é–‹å§‹åŸ·è¡Œé€±å ±ä»»å‹™...');

    try {
        // 1. åŸ·è¡Œ SQLite è„«æ°´æ¼”ç®—æ³•ï¼Œéæ¿¾é‡è¤‡è½‰è¼‰
        const articles = db.getWeeklyArticles();
        
        if (!articles || articles.length === 0) {
            log('ğŸ’¤', 'æœ¬é€±ç„¡æ–°èè³‡æ–™ï¼Œè·³éã€‚');
            return;
        }

        log('ğŸ“Š', `åŸå§‹æ•¸æ“šç´„ 2500 å‰‡ï¼Œç¶“æ¼”ç®—æ³•è„«æ°´å¾Œå‰©ä¸‹: ${articles.length} å‰‡ç²¾è¯ã€‚`);

        // 2. é™åˆ¶çµ¦ AI çš„æœ€å¤§æ•¸é‡ï¼ˆå–å‰ 100 å‰‡ï¼‰ï¼Œç¢ºä¿ä¸æœƒè¶…é Token é™åˆ¶
        const selectedArticles = articles.slice(0, 100);

        // 3. AI å¼•æ“è‡ªå‹•å‚™æ´é‚è¼¯
        let aiResult;
        // å¦‚æœ .env è£¡é¢çš„ OPENAI_API_KEY æ˜¯ç©ºçš„æˆ–æ²’å¡«ï¼Œæœƒè‡ªå‹•èµ° Gemini
        if (openaiKey && openaiKey.startsWith('sk-')) {
            log('ğŸ§ ', 'ä½¿ç”¨ OpenAI å¼•æ“é€²è¡Œé€±å ±ç¸½çµ...');
            aiResult = await getOpenAISummary(selectedArticles);
        } else {
            log('ğŸ§ ', 'æœªåµæ¸¬åˆ°æœ‰æ•ˆ OpenAI Keyï¼Œè‡ªå‹•ä½¿ç”¨ Gemini å¼•æ“å‚™æ´...');
            // Gemini æ¨¡å¼ (å‚³å…¥ null ä»£è¡¨å…¨æ–°é€±å ±åˆ†æ)
            aiResult = await getSummary(selectedArticles, null);
        }

        // 4. æ ¼å¼åŒ–é€±å ±
        const weeklyReport = `
# ğŸ“… **AI æŠ•è³‡é€±å ± (Weekly Insight)**
---
**æœ¬é€±æƒ…ç·’æŒ‡æ•¸**: ${aiResult.sentiment_score > 0 ? 'ğŸ”¥' : 'â„ï¸'} ${aiResult.sentiment_score}

## ğŸ“ **ä¸€é€±é‡é»å›é¡§**
${aiResult.summary.replace(/<[^>]*>/g, '')} 

## ğŸ¤– **æœ¬é€±é—œéµå¯¦é«”**
${aiResult.entities ? aiResult.entities.map(e => `#${e}`).join(' ') : 'ç„¡'}

---
*Generated by NewsBot v2.5.2 (${openaiKey ? 'OpenAI' : 'Gemini'} Mode)*
        `.trim();

        // 5. ç™¼é€
        await sendDiscord(weeklyReport);
        log('âœ…', 'é€±å ±ä»»å‹™åœ“æ»¿å®Œæˆï¼');

    } catch (e) {
        log('âŒ', `é€±å ±åŸ·è¡Œå¤±æ•—: ${e.message}`);
        console.error(e);
    }
}

// è¨­å®šæ’ç¨‹ï¼šæ¯é€±äº” 17:00
log('ğŸ•°ï¸', 'é€±å ±æ©Ÿå™¨äººå·²å°±ç·’ (æ¯é€±äº” 17:00)');
cron.schedule('0 17 * * 5', () => runWeeklyTask());

// æ¸¬è©¦ç”¨ (æ­£å¼ç’°å¢ƒè«‹è¨»è§£æ‰)
// runWeeklyTask();