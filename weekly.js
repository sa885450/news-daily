require('dotenv').config();
const cron = require('node-cron');
const db = require('./lib/db');
const { getWeeklySummary } = require('./lib/ai');
const { sendDiscord, log } = require('./lib/utils');
const { rawKeywords } = require('./lib/config');

async function runWeeklyTask() {
    log('ğŸ“…', 'é–‹å§‹åŸ·è¡Œé€±å ±ä»»å‹™ (Map-Reduce ç©©å®šç‰ˆ)...');

    try {
        // ğŸŸ¢ éšæ®µä¸€ï¼šSQLite æŒ‡ç´‹å»é‡
        // é€™è£¡æœƒå¾ DB æ’ˆå‡º "å»é™¤é‡è¤‡è½‰è¼‰" å¾Œçš„æ–°è
        const articles = db.getWeeklyArticles();
        
        if (!articles || articles.length === 0) {
            log('ğŸ’¤', 'æœ¬é€±ç„¡æ–°èè³‡æ–™ï¼Œè·³éã€‚');
            return;
        }
        log('ğŸ“Š', `è³‡æ–™åº«åˆæ­¥å»é‡å¾Œå‰©é¤˜: ${articles.length} å‰‡`);

        // ğŸŸ¢ éšæ®µäºŒï¼šåˆ†æ•¸æ¬Šé‡éæ¿¾ (Keyword Weighting)
        // å¹«æ¯å‰‡æ–°èæ‰“åˆ†æ•¸ï¼Œç¢ºä¿ AI çœ‹åˆ°çš„æ˜¯çœŸæ­£é‡è¦çš„å…§å®¹
        const scoredArticles = articles.map(article => {
            let score = 0;
            const text = (article.title + (article.content || "")).toLowerCase();
            
            // åŸºç¤åˆ†ï¼šæ¯ä¸­ä¸€å€‹é—œéµå­— +1 åˆ†
            rawKeywords.forEach(k => {
                if (text.includes(k.toLowerCase())) score += 1;
            });

            // åŠ æ¬Šåˆ†ï¼šæ¨™é¡Œæœ‰é—œéµå­—é¡å¤– +2 åˆ†
            rawKeywords.forEach(k => {
                if (article.title.toLowerCase().includes(k.toLowerCase())) score += 2;
            });

            // æ—¥æœŸåŠ æ¬Šï¼šè¶Šæ–°çš„æ–°èåˆ†æ•¸ç¨å¾®é«˜ä¸€é» (+0.1)
            // é€™æ˜¯ç‚ºäº†åœ¨åŒåˆ†æ™‚å„ªå…ˆé¸æ–°çš„
            score += 0.1; 

            return { ...article, weight: score };
        });

        // æ’åºä¸¦å– Top 120 (4 æ‰¹æ¬¡ * 30 å‰‡)
        scoredArticles.sort((a, b) => b.weight - a.weight);
        const topArticles = scoredArticles.slice(0, 120);
        
        log('âš–ï¸', `æ¬Šé‡éæ¿¾å¾Œå– Top ${topArticles.length} (æœ€é«˜åˆ†: ${topArticles[0]?.weight.toFixed(1)}) é€²è¡Œ AI åˆ†æ...`);

        // ğŸŸ¢ éšæ®µä¸‰ï¼šéšå±¤å¼ç¸½çµ (Map-Reduce)
        // é€™è£¡æœƒè‡ªå‹•åˆ†æ‰¹è™•ç†ï¼Œä¸¦åŒ…å«é‡è©¦æ©Ÿåˆ¶
        const aiResult = await getWeeklySummary(topArticles);

        // 4. æ ¼å¼åŒ–é€±å ±
        const weeklyReport = `
# ğŸ“… **AI æŠ•è³‡é€±å ± (Weekly Insight)**
---
**æœ¬é€±æƒ…ç·’æŒ‡æ•¸**: ${aiResult.sentiment_score > 0 ? 'ğŸ”¥' : 'â„ï¸'} ${aiResult.sentiment_score}

## ğŸ“ **ä¸€é€±é‡é»å›é¡§**
${aiResult.summary.replace(/<[^>]*>/g, '')} 

## ğŸ¤– **æœ¬é€±é—œéµå¯¦é«”**
${aiResult.entities ? aiResult.entities.map(e => `#${e}`).join(' ') : 'ç„¡'}

## ğŸ§­ **äº”åŠ›åˆ†æ**
- ğŸ›ï¸ æ”¿ç­–: ${aiResult.dimensions?.policy || 0.5}
- ğŸ’° è³‡é‡‘: ${aiResult.dimensions?.market || 0.5}
- ğŸ­ ç”¢æ¥­: ${aiResult.dimensions?.industry || 0.5}
- ğŸŒ åœ‹éš›: ${aiResult.dimensions?.international || 0.5}
- ğŸ“‰ æŠ€è¡“: ${aiResult.dimensions?.technical || 0.5}

---
*Generated by NewsBot v2.6.1 (Robust Gemini Map-Reduce)*
        `.trim();

        // 5. ç™¼é€
        await sendDiscord(weeklyReport);
        log('âœ…', 'é€±å ±ç™¼é€å®Œæˆï¼');

    } catch (e) {
        log('âŒ', `é€±å ±åŸ·è¡Œå¤±æ•—: ${e.message}`);
        console.error(e);
    }
}

// è¨­å®šæ’ç¨‹ï¼šæ¯é€±äº” 17:00
log('ğŸ•°ï¸', 'é€±å ±æ©Ÿå™¨äººå·²å°±ç·’ (æ¯é€±äº” 17:00)');
cron.schedule('0 17 * * 5', () => runWeeklyTask());

// æ¸¬è©¦ç”¨ (å»ºè­°é‡å•Ÿå¾Œå…ˆè·‘ä¸€æ¬¡ç¢ºèªç©©å®šæ€§)
// runWeeklyTask();